import time
import sqlite3
import requests
import pandas as pd
from datetime import datetime
from binance.client import Client

# Binance API Keyï¼ˆå¦‚æœæœ‰æ›´é«˜é€Ÿç‡éœ€æ±‚ï¼Œå¯ä»¥æ·»åŠ è‡ªå·±çš„ API Keyï¼‰
API_KEY = ""
API_SECRET = ""

# è¿æ¥ Binance API
client = Client(API_KEY, API_SECRET)

# åˆ›å»º SQLite æ•°æ®åº“
DB_NAME = "btc_ohlc.db"

def create_database():
    """ åˆ›å»º SQLite æ•°æ®åº“ & K çº¿è¡¨æ ¼ """
    conn = sqlite3.connect(DB_NAME)
    cursor = conn.cursor()
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS btc_ohlc (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            timestamp INTEGER UNIQUE,
            open REAL,
            high REAL,
            low REAL,
            close REAL,
            volume REAL
        )
    """)
    conn.commit()
    conn.close()

def fetch_and_store_ohlc():
    """ ä» Binance API çˆ¬å–æ¯”ç‰¹å¸ K çº¿æ•°æ®ï¼ˆ2017å¹´è‡³ä»Šï¼‰å¹¶å­˜å…¥æ•°æ®åº“ """
    conn = sqlite3.connect(DB_NAME)
    cursor = conn.cursor()

    # å¼€å§‹æ—¶é—´ï¼ˆ2017å¹´1æœˆ1æ—¥ï¼‰
    start_time = datetime.strptime("2017-01-01", "%Y-%m-%d")
    start_str = str(int(start_time.timestamp() * 1000))  # è½¬æ¢ä¸ºæ¯«ç§’

    # è·å–å†å²æ•°æ®
    print("æ­£åœ¨çˆ¬å– BTC/USDT å†å² K çº¿æ•°æ®...")
    while True:
        try:
            klines = client.get_klines(
                symbol="BTCUSDT",
                interval=Client.KLINE_INTERVAL_1MINUTE,
                startTime=start_str,
                limit=1000  # Binance å•æ¬¡æœ€å¤§è¿”å› 1000 æ ¹ K çº¿
            )
            
            if not klines:
                print("å·²è·å–æ‰€æœ‰æ•°æ®ï¼Œçˆ¬å–å®Œæˆï¼")
                break
            
            for k in klines:
                timestamp, open_, high, low, close, volume = int(k[0]), float(k[1]), float(k[2]), float(k[3]), float(k[4]), float(k[5])
                
                # æ’å…¥æ•°æ®åº“ï¼ˆå¦‚æœæ—¶é—´æˆ³å·²å­˜åœ¨ï¼Œåˆ™è·³è¿‡ï¼‰
                cursor.execute("""
                    INSERT OR IGNORE INTO btc_ohlc (timestamp, open, high, low, close, volume) 
                    VALUES (?, ?, ?, ?, ?, ?)
                """, (timestamp, open_, high, low, close, volume))
            
            conn.commit()

            # å–æœ€åä¸€æ¡æ•°æ®çš„æ—¶é—´æˆ³ï¼Œä½œä¸ºä¸‹æ¬¡è¯·æ±‚çš„èµ·ç‚¹
            start_str = str(int(klines[-1][0]) + 1)

            # 0.5 ç§’é—´éš”ï¼Œé¿å… API é™åˆ¶
            time.sleep(0.5)

        except Exception as e:
            print(f"âŒ å‘ç”Ÿé”™è¯¯: {e}")
            time.sleep(10)  # å¦‚æœå‡ºç°é”™è¯¯ï¼Œæš‚åœ 10 ç§’åé‡è¯•

    conn.close()
    print("âœ… BTC/USDT å†å²æ•°æ®å­˜å‚¨å®Œæˆï¼")

def fetch_latest_data():
    """ è·å–æœ€æ–° K çº¿æ•°æ®å¹¶å®æ—¶æ›´æ–°æ•°æ®åº“ """
    conn = sqlite3.connect(DB_NAME)
    cursor = conn.cursor()
    
    while True:
        try:
            # è·å–æœ€æ–°çš„ä¸€æ ¹ K çº¿
            klines = client.get_klines(symbol="BTCUSDT", interval=Client.KLINE_INTERVAL_1MINUTE, limit=1)
            if klines:
                k = klines[0]
                timestamp, open_, high, low, close, volume = int(k[0]), float(k[1]), float(k[2]), float(k[3]), float(k[4]), float(k[5])

                # æ›´æ–°æ•°æ®åº“
                cursor.execute("""
                    INSERT OR REPLACE INTO btc_ohlc (timestamp, open, high, low, close, volume) 
                    VALUES (?, ?, ?, ?, ?, ?)
                """, (timestamp, open_, high, low, close, volume))
                conn.commit()
                print(f"ğŸ“Š æœ€æ–°æ•°æ®æ›´æ–°: æ—¶é—´={datetime.fromtimestamp(timestamp / 1000)}, æ”¶ç›˜ä»·={close}")

            time.sleep(60)  # æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
        except Exception as e:
            print(f"âŒ è·å–æœ€æ–°æ•°æ®æ—¶å‡ºé”™: {e}")
            time.sleep(10)

    conn.close()

if __name__ == "__main__":
    create_database()
    fetch_and_store_ohlc()  # çˆ¬å–å†å²æ•°æ®
    fetch_latest_data()  # å¼€å§‹å®æ—¶æ›´æ–°æ•°æ®
